<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Your Tool Key</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>Your Tool Key</h1>
        <div id="keyDisplay"></div>
        <button id="renewKeyBtn">Generate New Key</button>
    </div>

    <script>
        // ===== KIỂM TRA BẢO MẬT NÂNG CAO =====
        const kiemTraBaoMat = () => {
            const urlParams = new URLSearchParams(window.location.search);
            const thamSo = {
                token: urlParams.get('vt'),       // Token xác minh
                session: urlParams.get('session'), // ID phiên
                timestamp: urlParams.get('ts')    // Thời gian
            };

            // Kiểm tra các tham số bắt buộc
            if (!thamSo.token || !thamSo.session || !thamSo.timestamp) {
                baoMatThatBai();
                return false;
            }

            // Kiểm tra token trong localStorage
            if (thamSo.token !== localStorage.getItem('yt_verify_token')) {
                baoMatThatBai();
                return false;
            }

            // Kiểm tra session trong sessionStorage
            if (thamSo.session !== sessionStorage.getItem('yeumoney_session')) {
                baoMatThatBai();
                return false;
            }

            // Kiểm tra thời gian (5 phút)
            const thoiGian = (Date.now() - parseInt(thamSo.timestamp)) / 1000 / 60;
            if (thoiGian > 5) {
                baoMatThatBai();
                return false;
            }

            return true;
        };

        const baoMatThatBai = () => {
            // Xóa tất cả dữ liệu
            localStorage.removeItem('yt_verify_token');
            localStorage.removeItem('robloxKey');
            sessionStorage.removeItem('yeumoney_session');
            
            // Chuyển hướng về trang chính
            window.location.href = "https://xfearyzer.github.io?error=truy_cap_khong_hop_le";
        };

        if (!kiemTraBaoMat()) {
            // Dừng thực thi nếu kiểm tra thất bại
            throw new Error("Xác minh bảo mật thất bại");
        }

        // Xóa token sau khi xác minh
        localStorage.removeItem('yt_verify_token');
        // ===== KẾT THÚC PHẦN KIỂM TRA BẢO MẬT =====

        // Hàm tạo key ngẫu nhiên
        function generateKey() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let key = '';
            for (let i = 0; i < 10; i++) {
                key += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return `ROBLOX-${key}`;
        }

        // Xử lý khi trang load
        document.addEventListener('DOMContentLoaded', function() {
            const keyDisplay = document.getElementById('keyDisplay');
            const renewBtn = document.getElementById('renewKeyBtn');
            
            // Kiểm tra nếu vừa từ YeuMoney về
            if (localStorage.getItem('awaitingVerification') === 'true') {
                const newKey = generateKey();
                
                // Lưu key vào localStorage
                const expiryDate = new Date();
                expiryDate.setDate(expiryDate.getDate() + 7); // 7 ngày
                localStorage.setItem('robloxKey', newKey);
                localStorage.setItem('keyExpiry', expiryDate.getTime());
                localStorage.removeItem('awaitingVerification');
                
                // Hiển thị key
                displayKey(newKey, expiryDate);
            } else {
                // Kiểm tra key đã lưu
                const savedKey = localStorage.getItem('robloxKey');
                const expiry = localStorage.getItem('keyExpiry');
                
                if (savedKey && expiry && new Date().getTime() < expiry) {
                    displayKey(savedKey, new Date(parseInt(expiry)));
                } else {
                    // Nếu không có key hợp lệ, quay về trang chính
                    window.location.href = "https://xfearyzer.github.io";
                }
            }
            
            // Xử lý nút renew
            renewBtn.addEventListener('click', function() {
                // Lưu session mới cho lần renew
                const newSessionId = 'yz' + Math.random().toString(36).substr(2, 10);
                sessionStorage.setItem('yeumoney_session', newSessionId);
                
                // Tạo token mới
                const newToken = window.btoa(Date.now() + '|' + Math.random().toString(36));
                localStorage.setItem('yt_verify_token', newToken);
                
                // Chuyển hướng với tham số mới
                const returnUrl = encodeURIComponent(
                    `https://xfearyzer-verify.github.io/?session=${newSessionId}&vt=${newToken}&ts=${Date.now()}`
                );
                window.location.href = `https://yeumoney.com/go/SfSm2t3P?return_url=${returnUrl}`;
            });
        });
        
        // Hàm hiển thị key
        function displayKey(key, expiryDate) {
            const daysLeft = Math.ceil((expiryDate - new Date()) / (1000 * 60 * 60 * 24));
            
            document.getElementById('keyDisplay').innerHTML = `
                <div class="key-value">${key}</div>
                <div class="expiry-info">
                    Expires: ${expiryDate.toLocaleDateString()}
                    <br>(${daysLeft} days remaining)
                </div>
                <button id="copyKeyBtn">
                    <i class="far fa-copy"></i> Copy Key
                </button>
            `;
            
            // Xử lý nút copy
            document.getElementById('copyKeyBtn').addEventListener('click', function() {
                navigator.clipboard.writeText(key);
                alert('Key copied to clipboard!');
            });
        }
    </script>
</body>
</html>
