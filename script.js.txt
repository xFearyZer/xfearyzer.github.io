// Cáº¥u hÃ¬nh chung
const YEU_MONEY_LINK = "https://yeumoney.com/go/SfSm2t3P"; // Sá»­ dá»¥ng link thá»±c táº¿ cá»§a báº¡n
const WEBHOOK_URL = "https://canary.discord.com/api/webhooks/1403667787943120996/PA-03eIqcD8f8zT5YQD8eN0T9afY7wI6S5rT-ra1BU_9SfI4FVgQdnrAQ8z0a52jtYSs";
const KEY_EXPIRY_DAYS = 7;

// HÃ m táº¡o key
function generateKey() {
    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
    let randomPart = '';
    for (let i = 0; i < 10; i++) {
        randomPart += chars.charAt(Math.floor(Math.random() * chars.length));
    }
    return `KEY${KEY_EXPIRY_DAYS}DAY_${randomPart}`;
}

// HÃ m lÆ°u key
function saveKey(key) {
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + KEY_EXPIRY_DAYS);
    localStorage.setItem('licenseKey', key);
    localStorage.setItem('keyExpiry', expiryDate.getTime());
}

// HÃ m kiá»ƒm tra key
function loadKey() {
    const key = localStorage.getItem('licenseKey');
    const expiry = localStorage.getItem('keyExpiry');
    const now = new Date().getTime();
    
    if (key && expiry && now < expiry) {
        return key;
    }
    return null;
}

// Xá»­ lÃ½ cho trang index.html
if (document.getElementById('getKeyBtn')) {
    const getKeyBtn = document.getElementById('getKeyBtn');
    const redirectModal = document.getElementById('redirectModal');
    const confirmRedirect = document.getElementById('confirmRedirect');
    const cancelRedirect = document.getElementById('cancelRedirect');

    getKeyBtn.addEventListener('click', () => {
        redirectModal.classList.remove('hidden');
    });

    confirmRedirect.addEventListener('click', () => {
        // LÆ°u tráº¡ng thÃ¡i Ä‘ang chá» xÃ¡c minh
        localStorage.setItem('pendingVerification', 'true');
        
        // Má»Ÿ link YeuMoney trong tab má»›i
        window.open(YEU_MONEY_LINK, '_blank');
        
        // Sau 5 giÃ¢y kiá»ƒm tra vÃ  chuyá»ƒn trang (giáº£ láº­p)
        setTimeout(() => {
            if (confirm("Have you completed the verification?")) {
                const newKey = generateKey();
                saveKey(newKey);
                window.location.href = "key.html";
            }
        }, 5000);
    });

    cancelRedirect.addEventListener('click', () => {
        redirectModal.classList.add('hidden');
    });
}

// Xá»­ lÃ½ cho trang key.html
if (document.getElementById('keyDisplay')) {
    const keyDisplay = document.getElementById('keyDisplay');
    const renewKeyBtn = document.getElementById('renewKeyBtn');
    
    // Hiá»ƒn thá»‹ key
    const currentKey = loadKey();
    if (currentKey) {
        keyDisplay.innerHTML = `
            <div class="key-display">
                <div>Your License Key:</div>
                <div style="color: #00c6ff; font-size: 1.4rem; margin-top: 0.5rem;">${currentKey}</div>
                <div style="font-size: 0.8rem; margin-top: 0.5rem; color: rgba(255,255,255,0.7);">
                    Expires on ${new Date(parseInt(localStorage.getItem('keyExpiry'))).toLocaleDateString()}
                </div>
            </div>
        `;
        
        // Gá»­i thÃ´ng bÃ¡o Ä‘áº¿n Discord khi key Ä‘Æ°á»£c xem
        sendToDiscord(currentKey, "VIEWED");
    } else {
        window.location.href = "index.html";
    }
    
    // Xá»­ lÃ½ nÃºt táº¡o láº¡i key
    renewKeyBtn.addEventListener('click', () => {
        localStorage.setItem('pendingVerification', 'true');
        window.open(YEU_MONEY_LINK, '_blank');
        
        // Giáº£ láº­p xÃ¡c nháº­n hoÃ n thÃ nh
        setTimeout(() => {
            if (confirm("Have you completed the verification?")) {
                const newKey = generateKey();
                saveKey(newKey);
                window.location.reload();
            }
        }, 5000);
    });
}

// HÃ m gá»­i thÃ´ng bÃ¡o Ä‘áº¿n Discord
async function sendToDiscord(key, action) {
    try {
        const ip = await getPublicIP();
        const payload = {
            content: `ðŸ”‘ **Key ${action}**\n` +
                     `**Key:** \`${key}\`\n` +
                     `**IP:** ${ip}\n` +
                     `**Time:** ${new Date().toLocaleString()}`
        };
        
        await fetch(WEBHOOK_URL, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload)
        });
    } catch (error) {
        console.error("Discord webhook error:", error);
    }
}

// HÃ m láº¥y Ä‘á»‹a chá»‰ IP
async function getPublicIP() {
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        return data.ip;
    } catch {
        return "Unknown";
    }
}